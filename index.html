<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DentMetric Calculator</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://unpkg.com/konva@9.2.0/konva.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        metric: {
                            green: '#88E523', // Neon Green
                            black: '#000000', // Pure Black
                            dark: '#0a0a0a',  // Very dark gray
                            silver: '#A0AEC0',
                        }
                    },
                    fontFamily: {
                        sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon': '0 0 10px rgba(136, 229, 35, 0.3), inset 0 0 5px rgba(136, 229, 35, 0.1)',
                        'metal': 'inset 0 1px 0 rgba(255, 255, 255, 0.15), 0 4px 6px -1px rgba(0, 0, 0, 0.8)',
                    },
                    backgroundImage: {
                        'metal-gradient': 'linear-gradient(180deg, #2a2a2a 0%, #151515 100%)',
                        'metal-gradient-active': 'linear-gradient(180deg, #333333 0%, #1a1a1a 100%)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Global Styles */
        body {
            background-color: #000000;
            color: #FFFFFF;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Details Animation */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: slideDown 0.2s ease-in-out; }
        @keyframes slideDown {
            0% { opacity: 0; transform: translateY(-5px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Input autofill fix for dark mode */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #151515 inset !important;
            -webkit-text-fill-color: white !important;
        }

        select:invalid { color: #718096; }

        /* Metallic Card Class */
        .card-metallic {
            background: linear-gradient(180deg, #2b2b2b 0%, #121212 100%);
            border: 1px solid #333;
            border-top-color: #404040;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* Konva Background Grid */
        .konva-bg {
            background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 25px 25px;
        }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="pb-24 select-none font-sans antialiased min-h-screen bg-metric-black">

<div id="app" class="max-w-md mx-auto relative h-screen flex flex-col">

    <div v-if="currentTab === 'calc'" class="flex flex-col h-full">

        <div class="p-4 space-y-4 shrink-0 z-20 bg-metric-black">
            <div class="flex justify-center pt-2 pb-2">
                <img src="logo.png" alt="DentMetric" class="w-full max-w-[320px] h-auto object-contain drop-shadow-2xl">
            </div>

            <div class="card-metallic rounded-2xl p-4 relative overflow-hidden text-center">
                <div class="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
                <div class="text-[11px] uppercase font-bold text-gray-400 tracking-widest mb-1">–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞</div>
                <div class="text-5xl font-black transition-all duration-300"
                     :class="totalPrice > 0 ? 'text-metric-green drop-shadow-[0_0_15px_rgba(136,229,35,0.3)]' : 'text-gray-600'">
                    {{ totalPrice > 0 ? formatCurrency(totalPrice) : '---' }} <span v-if="totalPrice > 0" class="text-2xl align-top">‚ÇΩ</span>
                </div>
                <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1/2 h-4 blur-xl transition-all duration-300"
                     :class="totalPrice > 0 ? 'bg-metric-green/10' : 'bg-transparent'"></div>
            </div>

            <div class="flex space-x-1 bg-[#151515] p-1 rounded-xl border border-[#333]">
                <button @click="setMode('standard')" class="flex-1 py-3 text-xs font-bold rounded-lg transition-all uppercase tracking-wide"
                        :class="calcMode === 'standard' ? 'bg-metric-green text-black shadow-neon' : 'text-gray-400 hover:text-white'">
                    –°—Ç–∞–Ω–¥–∞—Ä—Ç
                </button>
                <button @click="setMode('time')" class="flex-1 py-3 text-xs font-bold rounded-lg transition-all uppercase tracking-wide"
                        :class="calcMode === 'time' ? 'bg-metric-green text-black shadow-neon' : 'text-gray-400 hover:text-white'">
                    –í—Ä–µ–º—è
                </button>
                <button @click="setMode('graphics')" class="flex-1 py-3 text-xs font-bold rounded-lg transition-all uppercase tracking-wide"
                        :class="calcMode === 'graphics' ? 'bg-metric-green text-black shadow-neon' : 'text-gray-400 hover:text-white'">
                    –ì—Ä–∞—Ñ–∏–∫–∞
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 pt-0 pb-24">

            <div v-if="calcMode === 'standard'" class="space-y-4">

                <div class="card-metallic rounded-2xl p-5">
                    <div class="mb-5">
                        <div class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest">–¢–∏–ø –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è</div>
                        <div class="flex space-x-3">
                            <div @click="setShape('circle')" class="flex-1 relative rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 border"
                                 :class="form.shape === 'circle' ? 'bg-[#222] border-metric-green shadow-neon' : 'bg-[#151515] border-white/5 hover:border-white/10'">
                                <div class="w-4 h-4 rounded-full border-2 mb-2 shadow-[0_0_5px_currentColor]"
                                     :class="form.shape === 'circle' ? 'border-metric-green bg-metric-green' : 'border-gray-500'"></div>
                                <span class="text-xs font-bold uppercase" :class="form.shape === 'circle' ? 'text-white' : 'text-gray-400'">–ö—Ä—É–≥/–û–≤–∞–ª</span>
                            </div>
                            <div @click="setShape('strip')" class="flex-1 relative rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 border"
                                 :class="form.shape === 'strip' ? 'bg-[#222] border-metric-green shadow-neon' : 'bg-[#151515] border-white/5 hover:border-white/10'">
                                <div class="w-6 h-2 rounded-sm mb-3 shadow-[0_0_5px_currentColor]"
                                     :class="form.shape === 'strip' ? 'bg-metric-green' : 'bg-gray-500'"></div>
                                <span class="text-xs font-bold uppercase" :class="form.shape === 'strip' ? 'text-white' : 'text-gray-400'">–ü–æ–ª–æ—Å–∞</span>
                            </div>
                        </div>
                        <br>
                        <div class="mb-2">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–†–∞–∑–º–µ—Ä</label>
                            <div class="relative group">
                                <select v-model="form.sizeCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                                    <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä</option>
                                    <option v-for="size in currentSizeList" :value="size.code">
                                        {{ size.name }}
                                    </option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                                    <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="showSizeMenu" class="absolute inset-0 z-50 flex items-end justify-center bg-black/80 backdrop-blur-sm animate-fade-in" @click.self="showSizeMenu = false">
                        <div class="bg-[#151F2E] w-full rounded-t-2xl p-5 border-t border-white/10 shadow-2xl space-y-4 pb-8">
                            <div class="flex justify-between items-center border-b border-white/5 pb-3">
                                <h3 class="text-white font-bold text-lg pl-1">
                                    –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä ({{ activeToolType === 'circle' ? '–ö—Ä—É–≥/–û–≤–∞–ª' : '–ü–æ–ª–æ—Å–∞' }})
                                </h3>
                                <button @click="showSizeMenu = false" class="text-gray-400 p-2 text-xl">‚úï</button>
                            </div>

                            <div class="grid grid-cols-2 gap-3 max-h-[50vh] overflow-y-auto">
                                <button v-for="s in (activeToolType === 'circle' ? DATA.circleSizes : DATA.stripSizes)"
                                        :key="s.code"
                                        @click="confirmAddShape(s.code)"
                                        class="card-metallic p-3 rounded-xl flex flex-col items-center justify-center gap-1 active:scale-95 transition-all hover:border-metric-green/50">
                                    <span class="text-metric-green font-bold text-base">{{ s.code }}</span>
                                    <span class="text-gray-400 text-xs text-center leading-tight">{{ s.name }}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-metallic rounded-2xl p-5">
                    <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è</div>
                    <div class="relative">
                        <select v-model="form.repairCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                            <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é</option>
                            <option v-for="r in DATA.repairTypes" :value="r.code">{{ r.name }}</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                            <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="card-metallic rounded-2xl p-5 space-y-4">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">–£—Å–ª–æ–≤–∏—è</div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                        <div class="relative">
                            <select v-model="form.riskCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                                <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</option>
                                <option v-for="risk in DATA.risks" :value="risk.code">{{ risk.name }}</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none"><svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                        <div class="relative">
                            <select v-model="form.materialCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                                <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>
                                <option v-for="m in DATA.materials" :value="m.code">{{ m.name }}</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none"><svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–ö–ª–∞—Å—Å –∞–≤—Ç–æ</label>
                        <div class="relative">
                            <select v-model="form.carClassCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                                <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∞–≤—Ç–æ</option>
                                <option v-for="c in DATA.carClasses" :value="c.code">{{ c.name }}</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none"><svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg></div>
                        </div>
                    </div>
                </div>

                <div class="card-metallic rounded-2xl p-5">
                    <div class="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-widest">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</label>
                    <div class="relative">
                        <select v-model="form.disassemblyCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                            <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∞—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</option>
                            <option v-for="d in DATA.disassembly" :value="d.code">{{ d.name }}</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                            <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <button @click="resetForm" class="w-full py-4 text-xs font-bold uppercase tracking-widest text-red-400 hover:text-red-300 hover:bg-red-900/10 border border-transparent hover:border-red-900/20 rounded-xl transition-all flex items-center justify-center space-x-2 opacity-80 hover:opacity-100">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <span>–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</span>
                </button>
            </div>

            <div v-if="calcMode === 'time'" class="space-y-4">

                <div class="card-metallic rounded-2xl p-5">
                    <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç</div>
                    <div class="flex gap-3">
                        <div class="relative flex-1">
                            <select v-model="form.masterIndex" required @change="updateRateFromMaster" class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                                <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</option>
                                <option v-for="(m, idx) in userSettings.masters" :value="idx">{{ m.name }}</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                                <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <div class="flex items-center bg-[#151515] border border-[#333] rounded-xl px-4 min-w-[100px] justify-center shadow-inner">
                             <span class="text-sm font-bold" :class="userSettings.hourlyRate > 0 ? 'text-metric-green' : 'text-gray-600'">
                                 {{ userSettings.hourlyRate > 0 ? formatCurrency(userSettings.hourlyRate) : '---' }}
                             </span>
                        </div>
                    </div>
                </div>

                <div class="card-metallic rounded-2xl p-5">
                    <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è</div>
                    <div class="relative">
                        <select v-model="form.repairCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                            <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é</option>
                            <option v-for="r in DATA.repairTypes" :value="r.code">{{ r.name }}</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                            <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="card-metallic rounded-2xl p-5">
                    <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã (–ß–∞—Å—ã)</div>
                    <input type="number" v-model.number="form.hours" min="0" step="0.5" placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—ã" inputmode="decimal" class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-xl font-bold shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none transition-colors placeholder-gray-600">
                </div>

                <div class="card-metallic rounded-2xl p-5 space-y-4">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">–£—Å–ª–æ–≤–∏—è</div>

                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                        <div class="relative">
                            <select v-model="form.riskCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                                <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</option>
                                <option v-for="risk in DATA.risks" :value="risk.code">{{ risk.name }}</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none"><svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg></div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                        <div class="relative">
                            <select v-model="form.materialCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                                <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>
                                <option v-for="m in DATA.materials" :value="m.code">{{ m.name }}</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none"><svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg></div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–ö–ª–∞—Å—Å –∞–≤—Ç–æ</label>
                        <div class="relative">
                            <select v-model="form.carClassCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                                <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∞–≤—Ç–æ</option>
                                <option v-for="c in DATA.carClasses" :value="c.code">{{ c.name }}</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none"><svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg></div>
                        </div>
                    </div>
                </div>

                <div class="card-metallic rounded-2xl p-5">
                    <div class="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-widest">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</label>
                    <div class="relative">
                        <select v-model="form.disassemblyCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                            <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∞—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</option>
                            <option v-for="d in DATA.disassembly" :value="d.code">{{ d.name }}</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                            <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <button @click="resetForm" class="w-full py-4 text-xs font-bold uppercase tracking-widest text-red-400 hover:text-red-300 hover:bg-red-900/10 border border-transparent hover:border-red-900/20 rounded-xl transition-all flex items-center justify-center space-x-2 opacity-80 hover:opacity-100">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <span>–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</span>
                </button>
            </div>

            <div v-if="calcMode === 'graphics'" class="h-full flex flex-col">

                <div v-if="graphicsStep === 1" class="space-y-4 animate-fade-in pt-4">
                    <h2 class="text-xl font-bold text-center mb-4 text-white">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</h2>
                    <button v-for="cls in graphicsData.carClasses" :key="cls.id" @click="selectGraphicsClass(cls)"
                            class="w-full card-metallic p-6 rounded-2xl flex flex-col items-center gap-3 active:scale-95 transition-transform border border-white/5 hover:border-metric-green/50">
                        <span class="text-4xl">{{ cls.icon }}</span>
                        <span class="font-bold text-lg tracking-wide">{{ cls.name }}</span>
                    </button>
                </div>

                <div v-if="graphicsStep === 2" class="animate-fade-in h-full flex flex-col pt-4">
                    <div class="flex items-center justify-between mb-4">
                        <button @click="graphicsStep = 1" class="text-sm text-metric-silver hover:text-white px-2">‚Üê –ù–∞–∑–∞–¥</button>
                        <h2 class="text-xl font-bold text-white">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å</h2>
                        <div class="w-8"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button v-for="part in graphicsData.partsList" :key="part.id" @click="selectGraphicsPart(part)"
                                class="aspect-square card-metallic border border-white/5 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition-all hover:bg-white/5 hover:border-metric-green/30">
                            <div class="text-metric-green text-opacity-80 font-black text-2xl">
                                <span v-if="part.icon === 'door'">üö™</span>
                                <span v-else-if="part.icon === 'hood'">üöò</span>
                                <span v-else-if="part.icon === 'fender'">üöô</span>
                                <span v-else-if="part.icon === 'trunk'">üì¶</span>
                                <span v-else>üîß</span>
                            </div>
                            <span class="font-medium text-sm">{{ part.name }}</span>
                        </button>
                    </div>
                </div>

                <div v-if="graphicsStep === 3" class="flex flex-col h-full animate-fade-in pt-2">
                    <div class="flex justify-between items-center mb-2">
                        <button @click="closeEditor" class="text-xs text-metric-silver px-2 py-1 rounded border border-white/10 hover:text-white">‚Üê –ù–∞–∑–∞–¥</button>
                        <span class="text-xs text-metric-green font-bold uppercase tracking-widest">{{ graphicsState.selectedPart?.name }} ‚Ä¢ {{ graphicsState.selectedClass?.name }}</span>
                        <button @click="resetGraphics" class="text-xs text-red-400 px-2 py-1 hover:text-red-300">–°–±—Ä–æ—Å</button>
                    </div>

                    <div class="flex-1 relative border border-white/10 rounded-xl overflow-hidden shadow-2xl konva-bg w-full min-h-[300px]" id="canvas-wrapper">
                        <div id="konva-container" class="absolute inset-0 w-full h-full"></div>
                        <div v-if="graphicsState.dents.length === 0" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-50">
                            <div class="text-center">
                                <div class="text-2xl mb-1">üëÜ</div>
                                <span class="text-xs uppercase font-bold tracking-widest">–ù–∞—Ä–∏—Å—É–π—Ç–µ –≤–º—è—Ç–∏–Ω—É</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 grid grid-cols-2 gap-3">
                        <button @click="openSizeMenu('circle')" class="card-metallic p-3 rounded-xl flex items-center gap-3 active:scale-95 hover:border-metric-green/30 transition-all">
                            <div class="w-6 h-6 rounded-full border-2 border-metric-green bg-metric-green/20"></div>
                            <div class="text-left"><div class="font-bold text-xs text-white">–í–º—è—Ç–∏–Ω–∞</div><div class="text-[9px] text-gray-500">–ö—Ä—É–≥/–û–≤–∞–ª</div></div>
                        </button>

                        <button @click="openSizeMenu('strip')" class="card-metallic p-3 rounded-xl flex items-center gap-3 active:scale-95 hover:border-metric-green/30 transition-all">
                            <div class="w-6 h-2 bg-metric-silver rotate-45 rounded-sm"></div>
                            <div class="text-left"><div class="font-bold text-xs text-white">–ü–æ–ª–æ—Å–∞</div><div class="text-[9px] text-gray-500">–¶–∞—Ä–∞–ø–∏–Ω–∞</div></div>
                        </button>
                    </div>
                </div>
            </div>
            <div v-if="showSizeMenu" class="absolute inset-0 z-50 flex items-end justify-center bg-black/80 backdrop-blur-sm animate-fade-in" @click.self="showSizeMenu = false">
                <div class="bg-[#151F2E] w-full rounded-t-2xl p-5 border-t border-white/10 shadow-2xl space-y-4 pb-8">
                    <div class="flex justify-between items-center border-b border-white/5 pb-3">
                        <h3 class="text-white font-bold text-lg pl-1">
                            –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä ({{ activeToolType === 'circle' ? '–ö—Ä—É–≥/–û–≤–∞–ª' : '–ü–æ–ª–æ—Å–∞' }})
                        </h3>
                        <button @click="showSizeMenu = false" class="text-gray-400 p-2 text-xl">‚úï</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 max-h-[50vh] overflow-y-auto">
                        <button v-for="s in (activeToolType === 'circle' ? DATA.circleSizes : DATA.stripSizes)"
                                :key="s.code"
                                @click="confirmAddShape(s.code)"
                                class="card-metallic p-3 rounded-xl flex flex-col items-center justify-center gap-1 active:scale-95 transition-all hover:border-metric-green/50">
                            <span class="text-metric-green font-bold text-base">{{ s.code }}</span>
                            <span class="text-gray-400 text-xs text-center leading-tight">{{ s.name }}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'settings'" class="p-4 space-y-4 overflow-y-auto pb-24">
        <div class="card-metallic rounded-2xl p-5">
            <h2 class="text-xl font-bold mb-1 text-white">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        </div>

        <div class="card-metallic rounded-2xl p-5 space-y-3">
            <div class="flex justify-between items-center mb-4">
                <div class="text-[10px] font-bold text-metric-green uppercase tracking-widest">–ú–∞—Å—Ç–µ—Ä–∞</div>
                <button @click="addMaster" class="text-xs text-metric-green border border-metric-green px-2 py-1 rounded hover:bg-metric-green hover:text-black transition-colors">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="space-y-3">
                <div v-for="(m, idx) in userSettings.masters" :key="idx" class="flex gap-2 items-center">
                    <input v-model="m.name" placeholder="–ò–º—è" class="flex-1 bg-[#151515] border border-[#333] rounded-lg p-2 text-sm text-white focus:border-metric-green outline-none">
                    <input type="number" v-model.number="m.rate" placeholder="‚ÇΩ/—á–∞—Å" class="w-20 bg-[#151515] border border-[#333] rounded-lg p-2 text-sm text-right text-white focus:border-metric-green outline-none">
                    <button @click="removeMaster(idx)" class="text-red-500 p-2 hover:bg-red-900/20 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="card-metallic rounded-2xl p-5">
            <div class="text-[10px] font-bold text-metric-green uppercase mb-4 tracking-widest">–ö—Ä—É–≥/–û–≤–∞–ª (–ë–∞–∑–∞)</div>
            <div v-for="size in DATA.circleSizes" :key="size.code" class="flex items-center justify-between mb-3 last:mb-0 border-b border-white/5 pb-2 last:border-0 last:pb-0">
                <div class="flex flex-col">
                    <span class="font-bold text-sm text-gray-300">{{ size.code }}</span>
                    <span class="text-xs text-gray-500">{{ size.name }}</span>
                </div>
                <input type="number" v-model.number="userSettings.prices[size.code]" inputmode="numeric" class="w-28 bg-[#151515] border border-[#333] rounded-lg p-2 text-right font-medium text-white shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none">
            </div>
        </div>

        <div class="card-metallic rounded-2xl p-5">
            <div class="text-[10px] font-bold text-metric-green uppercase mb-4 tracking-widest">–ü–æ–ª–æ—Å—ã (–ë–∞–∑–∞)</div>
            <div v-for="size in DATA.stripSizes" :key="size.code" class="flex items-center justify-between mb-3 last:mb-0 border-b border-white/5 pb-2 last:border-0 last:pb-0">
                <div class="flex flex-col">
                    <span class="font-bold text-sm text-gray-300">{{ size.code }}</span>
                    <span class="text-xs text-gray-500">{{ size.name }}</span>
                </div>
                <input type="number" v-model.number="userSettings.prices[size.code]" inputmode="numeric" class="w-28 bg-[#151515] border border-[#333] rounded-lg p-2 text-right font-medium text-white shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none">
            </div>
        </div>

        <div class="flex flex-col space-y-3 pt-4">
            <button @click="saveSettings" class="w-full bg-metric-green text-black font-bold py-3.5 rounded-xl active:opacity-90 transition-opacity shadow-[0_0_15px_rgba(136,229,35,0.4)]">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button @click="resetDefaults" class="w-full text-gray-400 text-sm font-medium py-3 hover:text-white transition-colors">–°–±—Ä–æ—Å–∏—Ç—å –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º</button>
        </div>
    </div>

    <div v-if="currentTab === 'info'" class="p-4 space-y-3 overflow-y-auto pb-24">
        <div class="flex items-center justify-center pb-4">
            <div class="px-5 py-1.5 rounded-full border border-white/10 bg-[#1a1a1a] shadow-lg">
                <span class="text-[10px] font-bold uppercase text-metric-green tracking-widest">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è & FAQ</span>
            </div>
        </div>

        <details class="group card-metallic rounded-2xl overflow-hidden transition-all">
            <summary class="flex items-center justify-between p-4 cursor-pointer select-none">
                <div class="flex items-center space-x-3">
                    <span class="text-lg opacity-80">‚ÑπÔ∏è</span>
                    <span class="font-bold text-sm text-white">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="px-5 pb-5 pt-0 text-sm text-gray-400 leading-relaxed border-t border-white/5 mt-2 pt-4">
                <ul class="space-y-2 list-disc pl-4 marker:text-metric-green">
                    <li>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—á–∏—Ç–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞ –æ–¥–Ω–æ–π –≤–º—è—Ç–∏–Ω—ã.</li>
                    <li>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞: <span class="text-white font-bold">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</span> –∏ <span class="text-white font-bold">–ü–æ –≤—Ä–µ–º–µ–Ω–∏</span>.</li>
                    <li>–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ = –æ–¥–Ω–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ. –ü–∞–∫–µ—Ç–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è.</li>
                </ul>
            </div>
        </details>

        <details class="group card-metallic rounded-2xl overflow-hidden transition-all">
            <summary class="flex items-center justify-between p-4 cursor-pointer select-none">
                <div class="flex items-center space-x-3">
                    <span class="text-lg opacity-80">üõ†Ô∏è</span>
                    <span class="font-bold text-sm text-white">–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="px-5 pb-5 pt-0 text-sm text-gray-400 leading-relaxed border-t border-white/5 mt-2 pt-4">
                <ol class="space-y-3 list-decimal pl-4 marker:text-metric-green marker:font-bold">
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞—Å—á–µ—Ç–∞ (—Å–≤–µ—Ä—Ö—É).</li>
                    <li>–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è (–ö—Ä—É–≥/–û–≤–∞–ª –∏–ª–∏ –ü–æ–ª–æ—Å–∞).</li>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä (S2-S11 –∏–ª–∏ LS1-LS8). –≠—Ç–æ –±–∞–∑–∞ —Ü–µ–Ω—ã.</li>
                    <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (–°–ª–æ–∂–Ω–æ—Å—Ç—å, –ú–∞—Ç–µ—Ä–∏–∞–ª, –ö–ª–∞—Å—Å, –†–∞–∑–±–æ—Ä–∫–∞).</li>
                    <li>–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</li>
                </ol>
            </div>
        </details>

        <details class="group card-metallic rounded-2xl overflow-hidden transition-all">
            <summary class="flex items-center justify-between p-4 cursor-pointer select-none">
                <div class="flex items-center space-x-3">
                    <span class="text-lg opacity-80">üìñ</span>
                    <span class="font-bold text-sm text-white">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="px-5 pb-5 pt-0 text-sm text-gray-400 leading-relaxed border-t border-white/5 mt-2 pt-4 space-y-5">
                <div>
                    <div class="font-bold text-metric-green text-[10px] uppercase mb-1 tracking-widest">–†–ê–ó–ú–ï–†</div>
                    <div class="text-gray-400 leading-snug">S (–ö—Ä—É–≥) –∏ LS (–ü–æ–ª–æ—Å–∞). –Ø–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–æ–π –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω—ã.</div>
                </div>
                <div>
                    <div class="font-bold text-metric-green text-[10px] uppercase mb-2 tracking-widest">–°–õ–û–ñ–ù–û–°–¢–¨ (K)</div>
                    <div class="space-y-1.5">
                        <div class="flex space-x-2"><span class="text-white font-bold w-6">K1:</span><span>–õ—ë–≥–∫–∞—è</span></div>
                        <div class="flex space-x-2"><span class="text-white font-bold w-6">K2:</span><span>–°—Ä–µ–¥–Ω—è—è</span></div>
                        <div class="flex space-x-2"><span class="text-white font-bold w-6">K3:</span><span>–°–ª–æ–∂–Ω–∞—è ‚Äî –∑–∞–ª–æ–º—ã, –ø–ª–æ—Ö–æ–π –¥–æ—Å—Ç—É–ø.</span></div>
                        <div class="flex space-x-2"><span class="text-white font-bold w-6">K4:</span><span>–≠–∫—Å—Ç—Ä–∞ ‚Äî –æ—Å—Ç—Ä—ã–µ —Å–∫–ª–∞–¥–∫–∏, —Ä–µ–±—Ä–∞.</span></div>
                    </div>
                </div>
                <div>
                    <div class="font-bold text-metric-green text-[10px] uppercase mb-1 tracking-widest">–ö–õ–ê–°–° –ê–í–¢–û</div>
                    <div class="text-gray-400 leading-snug">–°—Ç–∞–Ω–¥–∞—Ä—Ç (x1.0), –ü—Ä–µ–º–∏—É–º/–ù–æ–≤—ã–π (x1.2).</div>
                </div>
            </div>
        </details>

        <details class="group card-metallic rounded-2xl overflow-hidden transition-all">
            <summary class="flex items-center justify-between p-4 cursor-pointer select-none">
                <div class="flex items-center space-x-3">
                    <span class="text-lg opacity-80">‚è±Ô∏è</span>
                    <span class="font-bold text-sm text-white">–†–µ–∂–∏–º ¬´–ü–æ –≤—Ä–µ–º–µ–Ω–∏¬ª</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="px-5 pb-5 pt-0 text-sm text-gray-400 leading-relaxed border-t border-white/5 mt-2 pt-4">
                <p class="mb-4 leading-snug">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∏–ª–∏ –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.</p>
                <div class="bg-[#151515] border border-white/10 rounded-lg p-3 font-mono text-xs text-metric-green flex items-center justify-center">
                    –¶–µ–Ω–∞ = (–ß–∞—Å—ã √ó –°—Ç–∞–≤–∫–∞) √ó –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
                </div>
            </div>
        </details>

        <details class="group card-metallic rounded-2xl overflow-hidden transition-all">
            <summary class="flex items-center justify-between p-4 cursor-pointer select-none">
                <div class="flex items-center space-x-3">
                    <span class="text-lg opacity-80">üé®</span>
                    <span class="font-bold text-sm text-white">–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="px-5 pb-5 pt-0 text-sm text-gray-400 leading-relaxed border-t border-white/5 mt-2 pt-4">
                <p class="mb-2">–†–∞—Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–æ—â–∞–¥–∏ –∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è.</p>
                <ol class="space-y-2 list-decimal pl-4 marker:text-metric-green marker:font-bold">
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∞–≤—Ç–æ –∏ –¥–µ—Ç–∞–ª—å.</li>
                    <li>–î–æ–±–∞–≤—å—Ç–µ –≤–º—è—Ç–∏–Ω—É (–ö—Ä—É–≥) –∏–ª–∏ –ø–æ–ª–æ—Å—É.</li>
                    <li>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∏ –º–µ–Ω—è–π—Ç–µ —Ä–∞–∑–º–µ—Ä —Ñ–∏–≥—É—Ä—ã.</li>
                    <li><b class="text-white">–°–ª–æ–∂–Ω—ã–µ –∑–æ–Ω—ã:</b> –ï—Å–ª–∏ —Ñ–∏–≥—É—Ä–∞ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –∫—Ä–∞—Å–Ω—É—é –∑–æ–Ω—É (—Ä–µ–±—Ä–æ), —Ü–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.</li>
                </ol>
            </div>
        </details>

        <div class="border border-red-500/30 bg-red-900/10 rounded-2xl p-4 flex gap-4 items-start mt-4">
            <div class="text-2xl pt-1">‚ö†Ô∏è</div>
            <div>
                <div class="text-red-400 font-bold uppercase tracking-widest text-xs mb-1">–í–∞–∂–Ω–æ</div>
                <div class="text-sm text-gray-300 leading-relaxed">
                    –¶–µ–Ω–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ–π. –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –ø–æ—Å–ª–µ –∂–∏–≤–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–º.
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-full bg-[#050505] border-t border-[#222] flex justify-around items-center pb-[env(safe-area-inset-bottom)] z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.8)]">
        <button v-for="tab in tabs" :key="tab.id" @click="switchTab(tab.id)"
                class="flex-1 py-4 flex flex-col items-center justify-center transition-all duration-300"
                :class="currentTab === tab.id ? 'text-metric-green scale-105' : 'text-gray-600 hover:text-gray-400'">
            <span class="text-2xl mb-1 filter drop-shadow-[0_0_5px_currentColor]">{{ tab.icon }}</span>
            <span class="text-[9px] font-bold uppercase tracking-widest">{{ tab.label }}</span>
        </button>
    </div>

</div>

<script>
    const { createApp, ref, reactive, computed, watch, onMounted, nextTick } = Vue;

    // --- CONFIG & CONSTANTS ---
    const PRICE_BASE = 3000;
    const PRICE_LOG_MULT = 1500;
    const PX_TO_MM_SCALE = 2;
    const CELL_SIZE_MM2 = 2500;
    const RIB_MULTIPLIER = 1.3;

    // GRAPHICS ASSETS (SVG Paths & Ribs)
    const CAR_PARTS = {
        door: {
            id: 'door', name: '–î–≤–µ—Ä—å', icon: 'door',
            path: 'M20,20 L280,20 Q300,20 300,50 L300,350 Q300,380 280,380 L20,380 Q0,380 0,350 L0,50 Q0,20 20,20 Z',
            // Ribs visible: red with opacity
            ribs: [ { x: 0, y: 150, w: 300, h: 20 }, { x: 0, y: 320, w: 300, h: 30 } ]
        },
        hood: {
            id: 'hood', name: '–ö–∞–ø–æ—Ç', icon: 'hood',
            path: 'M50,20 L250,20 Q280,20 290,100 L300,350 Q300,380 150,390 Q0,380 0,350 L10,100 Q20,20 50,20 Z',
            ribs: [ { x: 140, y: 20, w: 20, h: 370 }, { x: 50, y: 100, w: 200, h: 20 } ]
        },
        fender: {
            id: 'fender', name: '–ö—Ä—ã–ª–æ', icon: 'fender',
            path: 'M20,20 L250,20 Q280,20 280,100 L280,350 Q150,250 20,350 L20,20 Z',
            ribs: [ { x: 20, y: 180, w: 260, h: 40 } ]
        },
        trunk: {
            id: 'trunk', name: '–ë–∞–≥–∞–∂–Ω–∏–∫', icon: 'trunk',
            path: 'M20,20 L280,20 L280,350 L20,350 Z',
            ribs: [ { x: 0, y: 200, w: 300, h: 30 } ]
        }
    };

    // STANDARD DATA
    const initialData = {
        repairTypes: [ { code: 'R1', name: '–ë–µ–∑ –ø–æ–∫—Ä–∞—Å–∫–∏', mult: 1.0 }, { code: 'R2', name: '–ü–æ–¥ –ø–æ–∫—Ä–∞—Å–∫—É', mult: 0.85 } ],
        materials: [ { code: 'M1', name: '–°—Ç–∞–ª—å', mult: 1.0 }, { code: 'M2', name: '–ê–ª—é–º–∏–Ω–∏–π', mult: 1.3 } ],
        carClasses: [ { code: 'CLASS_STD', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', mult: 1.0 }, { code: 'CLASS_PREM', name: '–ü—Ä–µ–º–∏—É–º / –ù–æ–≤—ã–π', mult: 1.2 } ],
        risks: [ { code: 'RK1', name: '–ù–∏–∑–∫–∏–π', matrixKey: 'K1' }, { code: 'RK2', name: '–°—Ä–µ–¥–Ω–∏–π', matrixKey: 'K2' }, { code: 'RK3', name: '–í—ã—Å–æ–∫–∏–π', matrixKey: 'K3' }, { code: 'RK4', name: '–≠–∫—Å—Ç—Ä–∞', matrixKey: 'K4' } ],
        disassembly: [ { code: 'Z0', name: '–ë–µ–∑ —Ä–∞–∑–±–æ—Ä–∫–∏', price: 0 }, { code: 'Z1', name: '–§–æ–Ω–∞—Ä—å', price: 1000 }, { code: 'Z2', name: '–î–≤–µ—Ä—å', price: 2000 }, { code: 'Z3', name: '–ü–æ—Ç–æ–ª–æ–∫', price: 4000 }, { code: 'Z4', name: '–î–≤–µ—Ä—å+–æ–±—à–∏–≤–∫–∞', price: 3000 } ],
        defaultMasters: [ { name: '–ê–Ω–¥—Ä–µ–π', rate: 5000 }, { name: '–ê–∫–∏–º', rate: 2500 } ],

        // Added 'area' in pixels relative to 1:1 scale on canvas for accurate starting size
        circleSizes: [
            { code: 'S2', name: '—Å –º–æ–Ω–µ—Ç—É', basePrice: 2000, radius: 15, area: 706 },
            { code: 'S4', name: '—Å –∫—É—Ä–∏–Ω–æ–µ —è–π—Ü–æ', basePrice: 3000, radius: 25, area: 1963 },
            { code: 'S6', name: '—Å –∞–ø–µ–ª—å—Å–∏–Ω', basePrice: 5000, radius: 35, area: 3848 },
            { code: 'S8', name: '—Å –ª–∞–¥–æ–Ω—å', basePrice: 7000, radius: 45, area: 6361 },
            { code: 'S10', name: '—Å —Ñ—É—Ç–±–æ–ª—å–Ω—ã–π –º—è—á', basePrice: 12000, radius: 60, area: 11309 },
            { code: 'S11', name: '–¥–≤–∞ –º—è—á–∞', basePrice: 15000, radius: 75, area: 17671 }
        ],
        stripSizes: [
            { code: 'LS1', name: '—Å —Å–ø–∏—á. –∫–æ—Ä–æ–±–æ–∫', basePrice: 4000, w: 40, h: 20, area: 800 },
            { code: 'LS2', name: '—Å –∫–∞—Ä–∞–Ω–¥–∞—à', basePrice: 6000, w: 80, h: 10, area: 800 },
            { code: 'LS3', name: '—Å –ª–∏–Ω–µ–π–∫—É', basePrice: 9000, w: 120, h: 10, area: 1200 },
            { code: 'LS4', name: '—Å –∫–Ω–∏–≥—É', basePrice: 13000, w: 150, h: 50, area: 7500 },
            { code: 'LS5', name: '—Å –Ω–æ—É—Ç–±—É–∫', basePrice: 16000, w: 200, h: 100, area: 20000 },
            { code: 'LS6', name: '—Å –ø–æ–ª–¥–≤–µ—Ä–∏', basePrice: 22000, w: 250, h: 150, area: 37500 },
            { code: 'LS7', name: '—Å –¥–≤–µ—Ä—å', basePrice: 30000, w: 280, h: 200, area: 56000 },
            { code: 'LS8', name: '–≤–µ—Å—å —ç–ª–µ–º–µ–Ω—Ç', basePrice: 42000, w: 300, h: 300, area: 90000 }
        ],

        complexityMatrix: { 'S2': { K1: 1.00, K2: 1.15, K3: 2.30, K4: 4.00 }, 'S4': { K1: 1.00, K2: 1.60, K3: 2.30, K4: 4.00 }, 'S6': { K1: 1.00, K2: 1.40, K3: 2.00, K4: 3.00 }, 'S8': { K1: 1.00, K2: 1.40, K3: 1.80, K4: 3.00 }, 'S10': { K1: 1.00, K2: 1.30, K3: 1.60, K4: 2.20 }, 'S11': { K1: 1.00, K2: 1.20, K3: 1.90, K4: 2.70 }, 'STRIP_DEFAULT': { K1: 0.95, K2: 1.0, K3: 1.15, K4: 1.3 } }
    };

    const APP = createApp({
        setup() {
            // STATE
            const currentTab = ref('calc'); // calc, settings, info
            const calcMode = ref('standard'); // standard, time, graphics
            const graphicsStep = ref(1); // 1=Class, 2=Part, 3=Canvas

            // Form Data (Standard/Time)
            const form = reactive({
                shape: 'circle', sizeCode: null, repairCode: null, riskCode: null,
                materialCode: null, carClassCode: null, disassemblyCode: null,
                hours: null, masterIndex: null
            });

            // Graphics Data
            const graphicsState = reactive({
                selectedClass: null,
                selectedPart: null,
                selectedSizeCode: 'S2', // DEFAULT SELECTED SIZE
                dents: []
            });
            const showSizeMenu = ref(false); // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –º–µ–Ω—é
            const activeToolType = ref(null); // –ö–∞–∫–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤—ã–±—Ä–∞–Ω ('circle' –∏–ª–∏ 'strip')
            const openSizeMenu = (type) => {
                haptic('selection');
                activeToolType.value = type;
                showSizeMenu.value = true;
            };
            // Settings
            const buildDefaultPrices = () => {
                const p = {};
                initialData.circleSizes.forEach(s => p[s.code] = s.basePrice);
                initialData.stripSizes.forEach(s => p[s.code] = s.basePrice);
                return p;
            };

            const userSettings = reactive({
                hourlyRate: 0,
                prices: buildDefaultPrices(),
                masters: JSON.parse(JSON.stringify(initialData.defaultMasters))
            });

            // KONVA VARS
            let stage = null, layerParts = null, layerDents = null, tr = null;

            // --- COMPUTED PRICES ---

            // 1. Standard Price Logic
            const standardPrice = computed(() => {
                if (!form.sizeCode || !form.repairCode || !form.riskCode || !form.materialCode || !form.carClassCode || !form.disassemblyCode) return 0;
                const base = userSettings.prices[form.sizeCode] || 0;
                const riskObj = initialData.risks.find(r => r.code === form.riskCode);
                const kKey = riskObj ? riskObj.matrixKey : 'K2';

                let matrixRow = initialData.complexityMatrix[form.sizeCode] || initialData.complexityMatrix['STRIP_DEFAULT'];
                let compMult = matrixRow[kKey] || 1.0;

                const repMult = initialData.repairTypes.find(r => r.code === form.repairCode)?.mult || 1.0;
                const matMult = initialData.materials.find(m => m.code === form.materialCode)?.mult || 1.0;
                const clsMult = initialData.carClasses.find(c => c.code === form.carClassCode)?.mult || 1.0;
                const disCost = initialData.disassembly.find(d => d.code === form.disassemblyCode)?.price || 0;

                const total = (base * repMult * matMult * compMult * clsMult) + disCost;
                return Math.round(total / 500) * 500;
            });

            // 2. Time Price Logic
            const timePrice = computed(() => {
                if (!form.hours || !form.repairCode || !form.riskCode || !form.materialCode || !form.carClassCode || !form.disassemblyCode) return 0;

                const riskObj = initialData.risks.find(r => r.code === form.riskCode);
                const kKey = riskObj ? riskObj.matrixKey : 'K2';
                const compMult = initialData.complexityMatrix['STRIP_DEFAULT'][kKey] || 1.0;

                const repMult = initialData.repairTypes.find(r => r.code === form.repairCode)?.mult || 1.0;
                const matMult = initialData.materials.find(m => m.code === form.materialCode)?.mult || 1.0;
                const clsMult = initialData.carClasses.find(c => c.code === form.carClassCode)?.mult || 1.0;

                const disCost = initialData.disassembly.find(d => d.code === form.disassemblyCode)?.price || 0;

                const laborBase = (form.hours * userSettings.hourlyRate);

                const total = (laborBase * repMult * matMult * compMult * clsMult) + disCost;
                return Math.round(total / 100) * 100;
            });

            // 3. Graphics Price Logic (Interpolation)
            const graphicsPrice = computed(() => {
                if (graphicsState.dents.length === 0) return 0;
                const sorted = [...graphicsState.dents].sort((a, b) => b.price - a.price);
                let total = sorted[0].price;
                for (let i = 1; i < sorted.length; i++) {
                    total += sorted[i].price * 0.5; // 50% discount for additional dents
                }
                return Math.round(total / 100) * 100;
            });

            // UNIFIED TOTAL PRICE
            const totalPrice = computed(() => {
                if (currentTab.value === 'calc') {
                    if (calcMode.value === 'standard') return standardPrice.value;
                    if (calcMode.value === 'time') return timePrice.value;
                    if (calcMode.value === 'graphics') return graphicsPrice.value;
                }
                return 0;
            });

            const currentSizeList = computed(() => form.shape === 'circle' ? initialData.circleSizes : initialData.stripSizes);

            const tabs = [
                { id: 'calc', label: '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä', icon: 'üßÆ' },
                { id: 'settings', label: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', icon: '‚öôÔ∏è' },
                { id: 'info', label: '–ò–Ω—Ñ–æ', icon: '‚ÑπÔ∏è' }
            ];

            const graphicsData = {
                carClasses: [
                    { id: 'sedan', name: '–°–µ–¥–∞–Ω', icon: 'üöó' },
                    { id: 'crossover', name: '–ö—Ä–æ—Å—Å–æ–≤–µ—Ä', icon: 'üöô' },
                    { id: 'suv', name: '–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫', icon: 'üöú' }
                ],
                partsList: Object.values(CAR_PARTS)
            };

            // --- METHODS ---

            const formatCurrency = (v) => new Intl.NumberFormat('ru-RU').format(v);

            const haptic = (type) => {
                const tg = window.Telegram?.WebApp;
                if (!tg?.HapticFeedback) return;
                if (tg.isVersionAtLeast && tg.isVersionAtLeast('6.1')) {
                    if (type === 'selection') tg.HapticFeedback.selectionChanged();
                    if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
                }
            };

            const setMode = (mode) => {
                calcMode.value = mode;
                haptic('selection');
                if (mode === 'graphics' && graphicsStep.value === 3) {
                    setTimeout(initKonva, 100);
                }
            };

            const switchTab = (tab) => {
                currentTab.value = tab;
                haptic('selection');
            };

            // Graphics Methods
            const selectGraphicsClass = (cls) => {
                graphicsState.selectedClass = cls;
                graphicsStep.value = 2;
                haptic('selection');
            };

            const selectGraphicsPart = (part) => {
                graphicsState.selectedPart = part;
                graphicsStep.value = 3;
                haptic('selection');
                nextTick(() => {
                    setTimeout(initKonva, 100);
                });
            };

            const closeEditor = () => {
                graphicsStep.value = 2;
                graphicsState.dents = [];
                haptic('selection');
            };

            const resetGraphics = () => {
                if (layerDents) {
                    layerDents.destroyChildren();
                    tr = new Konva.Transformer({
                        anchorStroke: '#88E523', anchorFill: '#0B121E', anchorSize: 10,
                        borderStroke: '#88E523', borderDash: [4, 4], centeredScaling: true
                    });
                    layerDents.add(tr);
                    layerDents.draw();
                }
                graphicsState.dents = [];
                haptic('selection');
            };

            const initKonva = () => {
                const container = document.getElementById('konva-container');
                if (!container) return;

                const w = container.offsetWidth;
                const h = container.offsetHeight;

                if (stage) stage.destroy();

                stage = new Konva.Stage({ container: 'konva-container', width: w, height: h });
                layerParts = new Konva.Layer();
                stage.add(layerParts);

                const partData = graphicsState.selectedPart;
                const scaleX = w / 320;
                const scaleY = h / 420;
                const scale = Math.min(scaleX, scaleY);

                const partShape = new Konva.Path({
                    data: partData.path,
                    fill: '#151F2E', stroke: '#334155', strokeWidth: 3 / scale,
                    shadowColor: 'black', shadowBlur: 20, shadowOpacity: 0.5,
                    scaleX: scale, scaleY: scale,
                    x: (w - (300 * scale)) / 2,
                    y: (h - (400 * scale)) / 2
                });
                layerParts.add(partShape);

                // Invisible Ribs (NOW VISIBLE as semi-transparent RED)
                if (partData.ribs) {
                    partData.ribs.forEach(rib => {
                        const ribRect = new Konva.Rect({
                            x: rib.x * scale + partShape.x(),
                            y: rib.y * scale + partShape.y(),
                            width: rib.w * scale, height: rib.h * scale,
                            fill: 'rgba(255, 50, 50, 0.25)', // VISIBLE RED ZONE
                            stroke: 'rgba(255, 50, 50, 0.5)',
                            strokeWidth: 1,
                            name: 'rib', listening: false
                        });
                        layerParts.add(ribRect);
                    });
                }

                layerDents = new Konva.Layer();
                stage.add(layerDents);

                tr = new Konva.Transformer({
                    anchorStroke: '#88E523', anchorFill: '#0B121E', anchorSize: 15,
                    borderStroke: '#88E523', borderDash: [4, 4], centeredScaling: true
                });
                layerDents.add(tr);

                stage.on('click tap', (e) => {
                    if (e.target === stage || e.target === partShape) tr.nodes([]);
                });

                layerParts.draw();
                layerDents.draw();
            };

            // Interpolation helper for smooth pricing
            const getInterpolatedPrice = (areaPx, type) => {
                const sizes = type === 'circle' ? initialData.circleSizes : initialData.stripSizes;
                // Sort sizes by area just in case
                const sortedSizes = [...sizes].sort((a,b) => a.area - b.area);

                // If smaller than smallest
                if (areaPx <= sortedSizes[0].area) return userSettings.prices[sortedSizes[0].code];
                // If larger than largest
                if (areaPx >= sortedSizes[sortedSizes.length-1].area) return userSettings.prices[sortedSizes[sortedSizes.length-1].code];

                // Find bracket
                for (let i = 0; i < sortedSizes.length - 1; i++) {
                    const s1 = sortedSizes[i];
                    const s2 = sortedSizes[i+1];
                    if (areaPx >= s1.area && areaPx <= s2.area) {
                        const p1 = userSettings.prices[s1.code];
                        const p2 = userSettings.prices[s2.code];
                        const ratio = (areaPx - s1.area) / (s2.area - s1.area);
                        return p1 + (p2 - p1) * ratio;
                    }
                }
                return userSettings.prices[sortedSizes[0].code];
            };

            // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ —é–∑–µ—Ä –≤—ã–±—Ä–∞–ª —Ä–∞–∑–º–µ—Ä –≤ –º–µ–Ω—é
            const confirmAddShape = (sizeCode) => {
                if (!stage) return;
                haptic('selection');

                // 1. –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
                showSizeMenu.value = false;

                const type = activeToolType.value;
                const centerX = stage.width() / 2;
                const centerY = stage.height() / 2;
                const id = Date.now();

                // 2. –ò—â–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
                let sizeObj;
                if (type === 'circle') {
                    sizeObj = initialData.circleSizes.find(s => s.code === sizeCode);
                } else {
                    sizeObj = initialData.stripSizes.find(s => s.code === sizeCode);
                }

                // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–±–æ—è
                if (!sizeObj) return;

                let shape;
                if (type === 'circle') {
                    shape = new Konva.Ellipse({
                        x: centerX, y: centerY,
                        radiusX: sizeObj.radius,
                        radiusY: sizeObj.radius,
                        fill: 'rgba(136, 229, 35, 0.3)', stroke: '#88E523', strokeWidth: 2,
                        draggable: true, name: 'dent', id: id.toString()
                    });
                } else {
                    shape = new Konva.Rect({
                        x: centerX - (sizeObj.w)/2,
                        y: centerY - (sizeObj.h)/2,
                        width: sizeObj.w,
                        height: sizeObj.h,
                        cornerRadius: 5,
                        fill: 'rgba(200, 200, 200, 0.3)', stroke: '#A0AEC0', strokeWidth: 2,
                        draggable: true, name: 'dent', id: id.toString()
                    });
                }

                // –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ (—Ç–∞ –∂–µ —Å–∞–º–∞—è, —á—Ç–æ –±—ã–ª–∞)
                const updateShapeCalc = () => {
                    const scaleX = shape.scaleX();
                    const scaleY = shape.scaleY();
                    let areaPx = 0;

                    if (shape.className === 'Ellipse') {
                        areaPx = Math.PI * (shape.radiusX() * scaleX) * (shape.radiusY() * scaleY);
                    } else {
                        areaPx = (shape.width() * scaleX) * (shape.height() * scaleY);
                    }

                    const shapeRect = shape.getClientRect();
                    const ribs = stage.find('.rib');
                    let isComplex = false;

                    for (let rib of ribs) {
                        if (Konva.Util.haveIntersection(rib.getClientRect(), shapeRect)) {
                            isComplex = true;
                            break;
                        }
                    }

                    let price = getInterpolatedPrice(areaPx, type);

                    if (isComplex) price *= RIB_MULTIPLIER;

                    if (isComplex) {
                        shape.stroke('#FF4444');
                        shape.fill('rgba(255, 68, 68, 0.3)');
                    } else {
                        shape.stroke(type === 'circle' ? '#88E523' : '#A0AEC0');
                        shape.fill(type === 'circle' ? 'rgba(136, 229, 35, 0.3)' : 'rgba(200, 200, 200, 0.3)');
                    }

                    const idx = graphicsState.dents.findIndex(d => d.id === id);
                    const dentData = { id, price, area: areaPx, isComplex };
                    if (idx === -1) graphicsState.dents.push(dentData);
                    else graphicsState.dents[idx] = dentData;
                };

                shape.on('dragmove transform', updateShapeCalc);
                shape.on('click tap', () => tr.nodes([shape]));

                layerDents.add(shape);
                tr.nodes([shape]);
                updateShapeCalc();
            };

            // Standard Logic helpers
            const setShape = (s) => { form.shape = s; form.sizeCode = null; haptic('selection'); };
            const resetForm = () => {
                form.sizeCode = null; form.repairCode = null; form.riskCode = null;
                form.materialCode = null; form.carClassCode = null; form.disassemblyCode = null;
                form.hours = null; form.masterIndex = null;
                haptic('selection');
            };
            const updateRateFromMaster = () => {
                if (form.masterIndex !== null) userSettings.hourlyRate = userSettings.masters[form.masterIndex].rate;
            };
            const addMaster = () => userSettings.masters.push({name:'', rate:0});
            const removeMaster = (i) => userSettings.masters.splice(i, 1);

            const saveSettings = () => {
                const dataToSave = { prices: userSettings.prices, masters: userSettings.masters };
                localStorage.setItem('dentRepairSettings_v5', JSON.stringify(dataToSave));

                const tg = window.Telegram?.WebApp;
                if (tg && tg.showPopup && tg.isVersionAtLeast && tg.isVersionAtLeast('6.2')) {
                    tg.showPopup({ title: '–ì–æ—Ç–æ–≤–æ', message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', buttons: [{type:'ok'}] });
                } else {
                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                }
                haptic('success');
            };

            const resetDefaults = () => {
                const runReset = () => {
                    const defaultPrices = buildDefaultPrices();
                    Object.keys(userSettings.prices).forEach(key => delete userSettings.prices[key]);
                    Object.assign(userSettings.prices, defaultPrices);
                    saveSettings();
                };
                if (confirm("–°–±—Ä–æ—Å–∏—Ç—å —Ü–µ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º?")) runReset();
            };

            // Telegram Main Button Sync
            watch(totalPrice, (val) => {
                if (window.Telegram?.WebApp?.MainButton) {
                    const btn = window.Telegram.WebApp.MainButton;
                    if (val > 0) {
                        btn.setText(`–ò–¢–û–ì–û: ${formatCurrency(val)} ‚ÇΩ`);
                        btn.show();
                    } else {
                        btn.hide();
                    }
                }
            });

            onMounted(() => {
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                    window.Telegram.WebApp.MainButton.setParams({ color: '#88E523', text_color: '#000000' });
                }
                // Load Settings logic
                const saved = localStorage.getItem('dentRepairSettings_v5');
                if (saved) {
                    const p = JSON.parse(saved);
                    if(p.prices) Object.assign(userSettings.prices, p.prices);
                    if(p.masters) userSettings.masters = p.masters;
                }
            });

            return {
                currentTab, calcMode, graphicsStep, form, userSettings, tabs,
                DATA: initialData, currentSizeList, graphicsData, graphicsState,
                totalPrice, formatCurrency,
                setMode, switchTab, setShape, resetForm, updateRateFromMaster, addMaster, removeMaster, saveSettings, resetDefaults,
                selectGraphicsClass, selectGraphicsPart, closeEditor, resetGraphics, showSizeMenu, activeToolType, openSizeMenu, confirmAddShape
            };
        }
    });

    APP.mount('#app');
</script>
</body>
</html>