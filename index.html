<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DentMetric Calculator</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              metric: {
                green: '#88E523', // Neon Green
                black: '#000000', // Pure Black
                dark: '#0a0a0a',  // Very dark gray
                silver: '#A0AEC0',
              }
            },
            fontFamily: {
              sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
            },
            boxShadow: {
              'neon': '0 0 10px rgba(136, 229, 35, 0.3), inset 0 0 5px rgba(136, 229, 35, 0.1)',
              'metal': 'inset 0 1px 0 rgba(255, 255, 255, 0.15), 0 4px 6px -1px rgba(0, 0, 0, 0.8)',
            },
            backgroundImage: {
               // Dark Metallic Gradient for Cards
              'metal-gradient': 'linear-gradient(180deg, #2a2a2a 0%, #151515 100%)',
              'metal-gradient-active': 'linear-gradient(180deg, #333333 0%, #1a1a1a 100%)',
            }
          }
        }
      }
    </script>

    <style>
      /* Global Styles */
      body {
        background-color: #000000; /* Requirement: Black Background */
        color: #FFFFFF;
        overscroll-behavior-y: none;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* Hide scrollbar */
      ::-webkit-scrollbar {
        width: 0px;
        background: transparent;
      }

      /* Custom animations */
      details > summary {
        list-style: none;
      }
      details > summary::-webkit-details-marker {
        display: none;
      }
      details[open] summary ~ * {
        animation: slideDown 0.2s ease-in-out;
      }
      @keyframes slideDown {
        0% { opacity: 0; transform: translateY(-5px); }
        100% { opacity: 1; transform: translateY(0); }
      }

      /* Input autofill fix for dark mode */
      input:-webkit-autofill,
      input:-webkit-autofill:hover, 
      input:-webkit-autofill:focus, 
      input:-webkit-autofill:active{
          -webkit-box-shadow: 0 0 0 30px #151515 inset !important;
          -webkit-text-fill-color: white !important;
      }
      
      /* Select placeholder styling */
      select:invalid {
        color: #718096;
      }

      /* Metallic Card Class */
      .card-metallic {
          background: linear-gradient(180deg, #2b2b2b 0%, #121212 100%);
          border: 1px solid #333;
          border-top-color: #404040; /* Highlight top edge */
          box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="pb-24 select-none font-sans antialiased min-h-screen bg-metric-black">

<div id="app" class="max-w-md mx-auto relative">
    
    <!-- ===========================
         TAB 1: CALCULATOR
         =========================== -->
    <div v-if="currentTab === 'calc'" class="p-4 space-y-4">
        
        <!-- Branding Logo (Image) -->
        <div class="flex justify-center pt-8 pb-4 px-4">
            <img src="logo.png" alt="DentMetric" class="w-full max-w-[320px] h-auto object-contain drop-shadow-2xl">
        </div>

        <!-- Price Display Card -->
        <div class="card-metallic rounded-2xl p-6 relative overflow-hidden">
            <!-- Top glow line -->
            <div class="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
            
            <div class="text-center relative z-10">
                <div class="text-[11px] uppercase font-bold text-gray-400 tracking-widest mb-1">–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞</div>
                <div class="text-5xl font-black transition-all duration-300"
                     :class="totalPrice > 0 ? 'text-metric-green drop-shadow-[0_0_15px_rgba(136,229,35,0.3)]' : 'text-gray-600'">
                    {{ totalPrice > 0 ? formatCurrency(totalPrice) : '---' }} <span v-if="totalPrice > 0" class="text-2xl align-top">‚ÇΩ</span>
                </div>
            </div>
            
            <!-- Bottom green glow reflection -->
            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-1/2 h-4 blur-xl transition-all duration-300"
                 :class="totalPrice > 0 ? 'bg-metric-green/10' : 'bg-transparent'"></div>
        </div>

        <!-- Mode Toggle -->
        <div class="flex space-x-2">
            <button 
                @click="setMode('standard')"
                class="flex-1 py-3 text-sm font-bold rounded-xl border transition-all duration-200 uppercase tracking-wide"
                :class="calcMode === 'standard' ? 'bg-metal-gradient-active border-metric-green text-metric-green shadow-neon' : 'card-metallic text-gray-400 hover:text-white border-transparent'"
            >
                –°—Ç–∞–Ω–¥–∞—Ä—Ç
            </button>
            <button 
                @click="setMode('time')"
                class="flex-1 py-3 text-sm font-bold rounded-xl border transition-all duration-200 uppercase tracking-wide"
                :class="calcMode === 'time' ? 'bg-metal-gradient-active border-metric-green text-metric-green shadow-neon' : 'card-metallic text-gray-400 hover:text-white border-transparent'"
            >
                –ü–æ –≤—Ä–µ–º–µ–Ω–∏
            </button>
        </div>

        <!-- Standard Mode Inputs -->
        <div v-if="calcMode === 'standard'" class="space-y-4">
            
            <!-- Main Inputs Container -->
            <div class="card-metallic rounded-2xl p-5">
                
                <!-- Shape Selection Section -->
                <div class="mb-5">
                    <div class="text-[10px] font-bold text-gray-500 uppercase mb-3 tracking-widest">–¢–∏–ø –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è</div>
                    <div class="flex space-x-3">
                        <div 
                            @click="setShape('circle')"
                            class="flex-1 relative rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 border"
                            :class="form.shape === 'circle' ? 'bg-[#222] border-metric-green shadow-neon' : 'bg-[#151515] border-white/5 hover:border-white/10'"
                        >
                            <!-- Circle Icon -->
                            <div class="w-4 h-4 rounded-full border-2 mb-2 shadow-[0_0_5px_currentColor]"
                                 :class="form.shape === 'circle' ? 'border-metric-green bg-metric-green' : 'border-gray-500'">
                            </div>
                            <span class="text-xs font-bold uppercase" :class="form.shape === 'circle' ? 'text-white' : 'text-gray-400'">–ö—Ä—É–≥/–û–≤–∞–ª</span>
                        </div>

                        <div 
                            @click="setShape('strip')"
                            class="flex-1 relative rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer transition-all duration-200 border"
                            :class="form.shape === 'strip' ? 'bg-[#222] border-metric-green shadow-neon' : 'bg-[#151515] border-white/5 hover:border-white/10'"
                        >
                            <!-- Strip Icon -->
                            <div class="w-6 h-2 rounded-sm mb-3 shadow-[0_0_5px_currentColor]"
                                 :class="form.shape === 'strip' ? 'bg-metric-green' : 'bg-gray-500'">
                            </div>
                            <span class="text-xs font-bold uppercase" :class="form.shape === 'strip' ? 'text-white' : 'text-gray-400'">–ü–æ–ª–æ—Å–∞</span>
                        </div>
                    </div>
                </div>

                <!-- Size Dropdown -->
                <div class="mb-2">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–†–∞–∑–º–µ—Ä</label>
                    <div class="relative group">
                        <select v-model="form.sizeCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                            <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä</option>
                            <option v-for="size in currentSizeList" :value="size.code">
                                {{ size.name }}
                            </option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                            <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technology Card -->
            <div class="card-metallic rounded-2xl p-5">
                <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è</div>
                <div class="relative">
                    <select v-model="form.repairCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                        <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é</option>
                        <option v-for="r in DATA.repairTypes" :value="r.code">
                            {{ r.name }} <!-- HIDDEN COEFFICIENT -->
                        </option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                        <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Mode Inputs -->
        <div v-else class="space-y-4">
             <!-- Master Selection -->
             <div class="card-metallic rounded-2xl p-5">
                <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç</div>
                <div class="flex gap-3">
                    <div class="relative flex-1">
                        <select v-model="form.masterIndex" required @change="updateRateFromMaster" class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                            <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</option>
                            <option v-for="(m, idx) in userSettings.masters" :value="idx">{{ m.name }}</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                            <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div class="flex items-center bg-[#151515] border border-[#333] rounded-xl px-4 min-w-[100px] justify-center shadow-inner">
                         <span class="text-sm font-bold" :class="userSettings.hourlyRate > 0 ? 'text-metric-green' : 'text-gray-600'">
                             {{ userSettings.hourlyRate > 0 ? formatCurrency(userSettings.hourlyRate) : '---' }}
                         </span>
                    </div>
                </div>
            </div>

            <!-- Technology (Time Mode) -->
            <div class="card-metallic rounded-2xl p-5">
                <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è</div>
                <div class="relative">
                    <select v-model="form.repairCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                        <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é</option>
                        <option v-for="r in DATA.repairTypes" :value="r.code">
                            {{ r.name }} <!-- HIDDEN COEFFICIENT -->
                        </option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                        <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>

            <!-- Labor Input -->
            <div class="card-metallic rounded-2xl p-5">
                <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã (–ß–∞—Å—ã)</div>
                <input 
                    type="number" 
                    v-model.number="form.hours" 
                    min="0" step="0.5" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—ã"
                    inputmode="decimal"
                    class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-xl font-bold shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none transition-colors placeholder-gray-600"
                >
            </div>
        </div>

        <!-- Conditions Card (Complexity / Material / Class) -->
        <div class="card-metallic rounded-2xl p-5 space-y-4">
            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">–£—Å–ª–æ–≤–∏—è</div>
            
            <!-- Complexity/Risk -->
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                <div class="relative">
                    <select v-model="form.riskCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                        <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</option>
                        <option v-for="risk in DATA.risks" :value="risk.code">
                            {{ risk.name }} 
                        </option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                        <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>

            <!-- Material -->
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                <div class="relative">
                    <select v-model="form.materialCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                        <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>
                        <option v-for="m in DATA.materials" :value="m.code">
                            {{ m.name }} <!-- HIDDEN COEFFICIENT -->
                        </option>
                    </select>
                     <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                        <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>

            <!-- Car Class -->
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–ö–ª–∞—Å—Å –∞–≤—Ç–æ</label>
                <div class="relative">
                    <select v-model="form.carClassCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                        <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∞–≤—Ç–æ</option>
                        <option v-for="c in DATA.carClasses" :value="c.code">
                            {{ c.name }} <!-- HIDDEN COEFFICIENT -->
                        </option>
                    </select>
                     <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                        <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add-ons Card -->
        <div class="card-metallic rounded-2xl p-5">
            <div class="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-widest">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</label>
            <div class="relative">
                <select v-model="form.disassemblyCode" required class="w-full bg-[#151515] border border-[#333] rounded-xl px-4 py-3 text-white text-base font-medium shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none appearance-none transition-colors">
                    <option :value="null" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∞—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</option>
                    <option v-for="d in DATA.disassembly" :value="d.code">
                        {{ d.name }} <!-- HIDDEN PRICE -->
                    </option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none">
                    <svg class="w-3 h-3 text-metric-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
        </div>

        <!-- RESET BUTTON -->
        <button 
            @click="resetForm" 
            class="w-full py-4 text-xs font-bold uppercase tracking-widest text-red-400 hover:text-red-300 hover:bg-red-900/10 border border-transparent hover:border-red-900/20 rounded-xl transition-all flex items-center justify-center space-x-2 opacity-80 hover:opacity-100"
        >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            <span>–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</span>
        </button>
    </div>

    <!-- ===========================
         TAB 2: SETTINGS
         =========================== -->
    <div v-if="currentTab === 'settings'" class="p-4 space-y-4">
        <div class="card-metallic rounded-2xl p-5">
            <h2 class="text-xl font-bold mb-1 text-white">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        </div>

        <!-- Masters Settings (New) -->
        <div class="card-metallic rounded-2xl p-5">
            <div class="flex justify-between items-center mb-4">
                <div class="text-[10px] font-bold text-metric-green uppercase tracking-widest">–ú–∞—Å—Ç–µ—Ä–∞</div>
                <button @click="addMaster" class="text-xs text-metric-green border border-metric-green px-2 py-1 rounded hover:bg-metric-green hover:text-black transition-colors">
                    + –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
            
            <div class="space-y-3">
                <div v-for="(master, idx) in userSettings.masters" :key="idx" class="flex gap-2 items-center">
                     <input 
                        v-model="master.name" 
                        placeholder="–ò–º—è"
                        class="flex-1 bg-[#151515] border border-[#333] rounded-lg p-2 text-sm text-white focus:border-metric-green outline-none"
                     >
                     <input 
                        type="number"
                        v-model.number="master.rate" 
                        placeholder="‚ÇΩ/—á–∞—Å"
                        class="w-20 bg-[#151515] border border-[#333] rounded-lg p-2 text-sm text-right text-white focus:border-metric-green outline-none"
                     >
                     <button @click="removeMaster(idx)" class="text-red-500 p-2 hover:bg-red-900/20 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                     </button>
                </div>
            </div>
        </div>

        <!-- Circle Prices -->
        <div class="card-metallic rounded-2xl p-5">
            <div class="text-[10px] font-bold text-metric-green uppercase mb-4 tracking-widest">–ö—Ä—É–≥/–û–≤–∞–ª (–ë–∞–∑–∞)</div>
            <div v-for="size in DATA.circleSizes" :key="size.code" class="flex items-center justify-between mb-3 last:mb-0 border-b border-white/5 pb-2 last:border-0 last:pb-0">
                <div class="flex flex-col">
                    <span class="font-bold text-sm text-gray-300">{{ size.code }}</span>
                    <span class="text-xs text-gray-500">{{ size.name }}</span>
                </div>
                <input 
                    type="number" 
                    v-model.number="userSettings.prices[size.code]" 
                    inputmode="numeric"
                    class="w-28 bg-[#151515] border border-[#333] rounded-lg p-2 text-right font-medium text-white shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none"
                >
            </div>
        </div>

        <!-- Strip Prices -->
        <div class="card-metallic rounded-2xl p-5">
            <div class="text-[10px] font-bold text-metric-green uppercase mb-4 tracking-widest">–ü–æ–ª–æ—Å—ã (–ë–∞–∑–∞)</div>
            <div v-for="size in DATA.stripSizes" :key="size.code" class="flex items-center justify-between mb-3 last:mb-0 border-b border-white/5 pb-2 last:border-0 last:pb-0">
                <div class="flex flex-col">
                    <span class="font-bold text-sm text-gray-300">{{ size.code }}</span>
                    <span class="text-xs text-gray-500">{{ size.name }}</span>
                </div>
                <input 
                    type="number" 
                    v-model.number="userSettings.prices[size.code]" 
                    inputmode="numeric"
                    class="w-28 bg-[#151515] border border-[#333] rounded-lg p-2 text-right font-medium text-white shadow-inner focus:border-metric-green/50 focus:ring-1 focus:ring-metric-green/50 outline-none"
                >
            </div>
        </div>

        <div class="flex flex-col space-y-3 pt-4 pb-8">
            <button @click="saveSettings" class="w-full bg-metric-green text-black font-bold py-3.5 rounded-xl active:opacity-90 transition-opacity shadow-[0_0_15px_rgba(136,229,35,0.4)]">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            <button @click="resetDefaults" class="w-full text-gray-400 text-sm font-medium py-3 hover:text-white transition-colors">
                –°–±—Ä–æ—Å–∏—Ç—å –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º
            </button>
        </div>
    </div>

    <!-- ===========================
         TAB 3: INSTRUCTIONS (Accordion Design)
         =========================== -->
    <div v-if="currentTab === 'info'" class="p-4 pb-24 space-y-3">
        <!-- Title -->
        <div class="flex items-center justify-center pb-4">
            <div class="px-5 py-1.5 rounded-full border border-white/10 bg-[#1a1a1a] shadow-lg">
                <span class="text-[10px] font-bold uppercase text-metric-green tracking-widest">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è & FAQ</span>
            </div>
        </div>

        <!-- Section 1: About App -->
        <details class="group card-metallic rounded-2xl overflow-hidden transition-all">
            <summary class="flex items-center justify-between p-4 cursor-pointer select-none">
                <div class="flex items-center space-x-3">
                    <span class="text-lg opacity-80">‚ÑπÔ∏è</span>
                    <span class="font-bold text-sm text-white">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="px-5 pb-5 pt-0 text-sm text-gray-400 leading-relaxed border-t border-white/5 mt-2 pt-4">
                <ul class="space-y-2 list-disc pl-4 marker:text-metric-green">
                    <li>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—á–∏—Ç–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞ –æ–¥–Ω–æ–π –≤–º—è—Ç–∏–Ω—ã.</li>
                    <li>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞: <span class="text-white font-bold">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</span> –∏ <span class="text-white font-bold">–ü–æ –≤—Ä–µ–º–µ–Ω–∏</span>.</li>
                    <li>–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ = –æ–¥–Ω–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ. –ü–∞–∫–µ—Ç–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è.</li>
                </ul>
            </div>
        </details>

        <!-- Section 2: How to use -->
        <details class="group card-metallic rounded-2xl overflow-hidden transition-all">
            <summary class="flex items-center justify-between p-4 cursor-pointer select-none">
                <div class="flex items-center space-x-3">
                    <span class="text-lg opacity-80">üõ†Ô∏è</span>
                    <span class="font-bold text-sm text-white">–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="px-5 pb-5 pt-0 text-sm text-gray-400 leading-relaxed border-t border-white/5 mt-2 pt-4">
                <ol class="space-y-3 list-decimal pl-4 marker:text-metric-green marker:font-bold">
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞—Å—á–µ—Ç–∞ (—Å–≤–µ—Ä—Ö—É).</li>
                    <li>–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è (–ö—Ä—É–≥/–û–≤–∞–ª –∏–ª–∏ –ü–æ–ª–æ—Å–∞).</li>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä (S2-S11 –∏–ª–∏ LS1-LS8). –≠—Ç–æ –±–∞–∑–∞ —Ü–µ–Ω—ã.</li>
                    <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (–°–ª–æ–∂–Ω–æ—Å—Ç—å, –ú–∞—Ç–µ—Ä–∏–∞–ª, –ö–ª–∞—Å—Å, –†–∞–∑–±–æ—Ä–∫–∞).</li>
                    <li>–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</li>
                </ol>
            </div>
        </details>

        <!-- Section 3: Decoding Parameters -->
        <details class="group card-metallic rounded-2xl overflow-hidden transition-all">
            <summary class="flex items-center justify-between p-4 cursor-pointer select-none">
                <div class="flex items-center space-x-3">
                    <span class="text-lg opacity-80">üìñ</span>
                    <span class="font-bold text-sm text-white">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="px-5 pb-5 pt-0 text-sm text-gray-400 leading-relaxed border-t border-white/5 mt-2 pt-4 space-y-5">
                <div>
                    <div class="font-bold text-metric-green text-[10px] uppercase mb-1 tracking-widest">–†–ê–ó–ú–ï–†</div>
                    <div class="text-gray-400 leading-snug">S (–ö—Ä—É–≥) –∏ LS (–ü–æ–ª–æ—Å–∞). –Ø–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–æ–π –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω—ã.</div>
                </div>
                <div>
                    <div class="font-bold text-metric-green text-[10px] uppercase mb-2 tracking-widest">–°–õ–û–ñ–ù–û–°–¢–¨ (K)</div>
                    <div class="space-y-1.5">
                            <div class="flex space-x-2"><span class="text-white font-bold w-6">K1:</span><span>–õ—ë–≥–∫–∞—è</span></div>
                            <div class="flex space-x-2"><span class="text-white font-bold w-6">K2:</span><span>–°—Ä–µ–¥–Ω—è—è</span></div>
                            <div class="flex space-x-2"><span class="text-white font-bold w-6">K3:</span><span>–°–ª–æ–∂–Ω–∞—è ‚Äî –∑–∞–ª–æ–º—ã, –ø–ª–æ—Ö–æ–π –¥–æ—Å—Ç—É–ø.</span></div>
                            <div class="flex space-x-2"><span class="text-white font-bold w-6">K4:</span><span>–≠–∫—Å—Ç—Ä–∞ ‚Äî –æ—Å—Ç—Ä—ã–µ —Å–∫–ª–∞–¥–∫–∏, —Ä–µ–±—Ä–∞.</span></div>
                    </div>
                </div>
                <div>
                    <div class="font-bold text-metric-green text-[10px] uppercase mb-1 tracking-widest">–ö–õ–ê–°–° –ê–í–¢–û</div>
                    <div class="text-gray-400 leading-snug">–°—Ç–∞–Ω–¥–∞—Ä—Ç (x1.0), –ü—Ä–µ–º–∏—É–º/–ù–æ–≤—ã–π (x1.2).</div>
                </div>
            </div>
        </details>

        <!-- Section 4: Time Mode -->
        <details class="group card-metallic rounded-2xl overflow-hidden transition-all">
            <summary class="flex items-center justify-between p-4 cursor-pointer select-none">
                <div class="flex items-center space-x-3">
                    <span class="text-lg opacity-80">‚è±Ô∏è</span>
                    <span class="font-bold text-sm text-white">–†–µ–∂–∏–º ¬´–ü–æ –≤—Ä–µ–º–µ–Ω–∏¬ª</span>
                </div>
                <svg class="w-5 h-5 text-gray-500 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="px-5 pb-5 pt-0 text-sm text-gray-400 leading-relaxed border-t border-white/5 mt-2 pt-4">
                <p class="mb-4 leading-snug">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∏–ª–∏ –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.</p>
                <div class="bg-[#151515] border border-white/10 rounded-lg p-3 font-mono text-xs text-metric-green flex items-center justify-center">
                    –¶–µ–Ω–∞ = (–ß–∞—Å—ã √ó –°—Ç–∞–≤–∫–∞) √ó –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
                </div>
            </div>
        </details>

        <!-- Important Warning -->
        <div class="border border-red-500/30 bg-red-900/10 rounded-2xl p-4 flex gap-4 items-start mt-4">
            <div class="text-2xl pt-1">‚ö†Ô∏è</div>
            <div>
                <div class="text-red-400 font-bold uppercase tracking-widest text-xs mb-1">–í–∞–∂–Ω–æ</div>
                <div class="text-sm text-gray-300 leading-relaxed">
                    –¶–µ–Ω–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ–π. –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –ø–æ—Å–ª–µ –∂–∏–≤–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞ –∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–º.
                </div>
            </div>
        </div>
    </div>

    <!-- ===========================
         BOTTOM NAVIGATION
         =========================== -->
    <div class="fixed bottom-0 left-0 w-full bg-[#050505] border-t border-[#222] flex justify-around items-center pb-[env(safe-area-inset-bottom)] z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.8)]">
        <button 
            v-for="tab in tabs" 
            :key="tab.id"
            @click="switchTab(tab.id)"
            class="flex-1 py-4 flex flex-col items-center justify-center transition-all duration-300"
            :class="currentTab === tab.id ? 'text-metric-green scale-105' : 'text-gray-600 hover:text-gray-400'"
        >
            <span class="text-2xl mb-1 filter drop-shadow-[0_0_5px_currentColor]">{{ tab.icon }}</span>
            <span class="text-[9px] font-bold uppercase tracking-widest">{{ tab.label }}</span>
        </button>
    </div>

</div>

<script>
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

    // --- CLIENT DATA (IMMUTABLE CONFIG) ---
    const initialData = {
      repairTypes: [
        { code: 'R1', name: '–ë–µ–∑ –ø–æ–∫—Ä–∞—Å–∫–∏', mult: 1.0 },
        { code: 'R2', name: '–ü–æ–¥ –ø–æ–∫—Ä–∞—Å–∫—É', mult: 0.85 }
      ],
      materials: [
        { code: 'M1', name: '–°—Ç–∞–ª—å', mult: 1.0 },
        { code: 'M2', name: '–ê–ª—é–º–∏–Ω–∏–π', mult: 1.3 }
      ],
      carClasses: [
        { code: 'CLASS_STD', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', mult: 1.0 },
        { code: 'CLASS_PREM', name: '–ü—Ä–µ–º–∏—É–º / –ù–æ–≤—ã–π', mult: 1.2 }
      ],
      // UI Selection for Complexity
      risks: [
        { code: 'RK1', name: '–ù–∏–∑–∫–∏–π', matrixKey: 'K1' },
        { code: 'RK2', name: '–°—Ä–µ–¥–Ω–∏–π', matrixKey: 'K2' },
        { code: 'RK3', name: '–í—ã—Å–æ–∫–∏–π', matrixKey: 'K3' },
        { code: 'RK4', name: '–≠–∫—Å—Ç—Ä–∞', matrixKey: 'K4' }
      ],
      disassembly: [
        { code: 'Z0', name: '–ë–µ–∑ —Ä–∞–∑–±–æ—Ä–∫–∏', price: 0 },
        { code: 'Z1', name: '–§–æ–Ω–∞—Ä—å', price: 1000 },
        { code: 'Z2', name: '–î–≤–µ—Ä—å', price: 2000 },
        { code: 'Z3', name: '–ü–æ—Ç–æ–ª–æ–∫', price: 4000 },
        { code: 'Z4', name: '–î–≤–µ—Ä—å+–æ–±—à–∏–≤–∫–∞', price: 3000 }
      ],
      // Default masters if none saved
      defaultMasters: [
        { name: '–ê–Ω–¥—Ä–µ–π', rate: 5000 },
        { name: '–ê–∫–∏–º', rate: 2500 }
      ],
      circleSizes: [
        { code: 'S2', name: '—Å –º–æ–Ω–µ—Ç—É', basePrice: 2000 },
        { code: 'S4', name: '—Å –∫—É—Ä–∏–Ω–æ–µ —è–π—Ü–æ', basePrice: 3000 },
        { code: 'S6', name: '—Å –∞–ø–µ–ª—å—Å–∏–Ω', basePrice: 5000 },
        { code: 'S8', name: '—Å –ª–∞–¥–æ–Ω—å', basePrice: 7000 },
        { code: 'S10', name: '—Å —Ñ—É—Ç–±–æ–ª—å–Ω—ã–π –º—è—á', basePrice: 12000 },
        { code: 'S11', name: '–¥–≤–∞ –º—è—á–∞', basePrice: 15000 }
      ],
      stripSizes: [
        { code: 'LS1', name: '—Å —Å–ø–∏—á. –∫–æ—Ä–æ–±–æ–∫', basePrice: 4000 },
        { code: 'LS2', name: '—Å –∫–∞—Ä–∞–Ω–¥–∞—à', basePrice: 6000 },
        { code: 'LS3', name: '—Å –ª–∏–Ω–µ–π–∫—É', basePrice: 9000 },
        { code: 'LS4', name: '—Å –∫–Ω–∏–≥—É', basePrice: 13000 },
        { code: 'LS5', name: '—Å –Ω–æ—É—Ç–±—É–∫', basePrice: 16000 },
        { code: 'LS6', name: '—Å –ø–æ–ª–¥–≤–µ—Ä–∏', basePrice: 22000 },
        { code: 'LS7', name: '—Å –¥–≤–µ—Ä—å', basePrice: 30000 },
        { code: 'LS8', name: '–≤–µ—Å—å —ç–ª–µ–º–µ–Ω—Ç', basePrice: 42000 }
      ],
      complexityMatrix: {
        'S2':  { K1: 1.00, K2: 1.15, K3: 2.30, K4: 4.00 },
        'S4':  { K1: 1.00, K2: 1.60, K3: 2.30, K4: 4.00 },
        'S6':  { K1: 1.00, K2: 1.40, K3: 2.00, K4: 3.00 },
        'S8':  { K1: 1.00, K2: 1.40, K3: 1.80, K4: 3.00 },
        'S10': { K1: 1.00, K2: 1.30, K3: 1.60, K4: 2.20 },
        'S11': { K1: 1.00, K2: 1.20, K3: 1.90, K4: 2.70 },
        'STRIP_DEFAULT': { K1: 0.95, K2: 1.0, K3: 1.15, K4: 1.3 }
      },
      defaultHourlyRate: 6000
    };

    const APP = createApp({
        setup() {
            // State
            const currentTab = ref('calc');
            const calcMode = ref('standard');
            
            // Initial form state with nulls to force selection
            const form = reactive({
                shape: 'circle',
                sizeCode: null,
                repairCode: null,
                riskCode: null,
                materialCode: null,
                carClassCode: null,
                disassemblyCode: null,
                hours: null,
                masterIndex: null
            });

            // Initialize User Settings (Prices & Masters)
            const buildDefaultPrices = () => {
                const p = {};
                initialData.circleSizes.forEach(s => p[s.code] = s.basePrice);
                initialData.stripSizes.forEach(s => p[s.code] = s.basePrice);
                return p;
            };

            const userSettings = reactive({
                hourlyRate: 0,
                prices: buildDefaultPrices(),
                masters: JSON.parse(JSON.stringify(initialData.defaultMasters)) // Deep copy
            });

            const tabs = [
                { id: 'calc', label: '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä', icon: 'üßÆ' },
                { id: 'settings', label: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', icon: '‚öôÔ∏è' },
                { id: 'info', label: '–ò–Ω—Ñ–æ', icon: '‚ÑπÔ∏è' }
            ];

            // Computed
            const currentSizeList = computed(() => {
                return form.shape === 'circle' ? initialData.circleSizes : initialData.stripSizes;
            });

            // --- MAIN CALCULATION LOGIC ---
            const totalPrice = computed(() => {
                // Return 0 if mandatory fields are missing
                if (calcMode.value === 'standard') {
                     if (!form.sizeCode || !form.repairCode || !form.riskCode || !form.materialCode || !form.carClassCode || !form.disassemblyCode) {
                         return 0;
                     }
                } else {
                     if (form.masterIndex === null || !form.repairCode || !form.hours || !form.riskCode || !form.materialCode || !form.carClassCode || !form.disassemblyCode) {
                         return 0;
                     }
                }

                // 1. Base Price from Size (lookup in userSettings for overrides)
                const sizeBase = userSettings.prices[form.sizeCode] || 0;

                // 2. Base Calculation (Standard vs Time)
                let calculationBase = 0;
                let complexityMult = 1.0;

                const riskObj = initialData.risks.find(r => r.code === form.riskCode);
                const kKey = riskObj ? riskObj.matrixKey : 'K2';

                if (calcMode.value === 'standard') {
                    // Standard Mode: Base Size Price
                    calculationBase = sizeBase;
                    
                    // Determine Complexity based on Size
                    let matrixRow = initialData.complexityMatrix[form.sizeCode];
                    if (!matrixRow) {
                        matrixRow = initialData.complexityMatrix['STRIP_DEFAULT'];
                    }
                    complexityMult = matrixRow ? matrixRow[kKey] : 1.0;
                } else {
                    // Time Mode: Labor Cost (Hours * Rate)
                    const laborCost = (form.hours || 0) * userSettings.hourlyRate;
                    calculationBase = laborCost;

                    // Use standard complexity multipliers for time mode (or strip default)
                    const matrixRow = initialData.complexityMatrix['STRIP_DEFAULT'];
                    complexityMult = matrixRow ? matrixRow[kKey] : 1.0;
                }

                // 3. Multipliers
                const repair = initialData.repairTypes.find(r => r.code === form.repairCode);
                const repairMult = repair ? repair.mult : 1.0;

                const material = initialData.materials.find(m => m.code === form.materialCode);
                const materialMult = material ? material.mult : 1.0;

                const carClass = initialData.carClasses.find(c => c.code === form.carClassCode);
                const carClassMult = carClass ? carClass.mult : 1.0;

                // 4. Add-on (Disassembly)
                const disassembly = initialData.disassembly.find(d => d.code === form.disassemblyCode);
                const disassemblyCost = disassembly ? disassembly.price : 0;

                // Formula: (Base * Repair * Material * Complexity * CarClass) + Disassembly
                const total = (calculationBase * repairMult * materialMult * complexityMult * carClassMult) + disassemblyCost;

                return Math.round(total / 500) * 500;
            });

            // Methods
            const updateRateFromMaster = () => {
                if (form.masterIndex === null) return;
                const master = userSettings.masters[form.masterIndex];
                if (master) {
                    userSettings.hourlyRate = master.rate;
                }
            };

            const addMaster = () => {
                userSettings.masters.push({ name: '', rate: 0 });
            };

            const removeMaster = (index) => {
                userSettings.masters.splice(index, 1);
            };

            const setMode = (mode) => {
                calcMode.value = mode;
                resetForm(); // Reset when switching modes for clarity
            };

            const setShape = (shape) => {
                form.shape = shape;
                // Reset size when shape changes because options change
                form.sizeCode = null; 
                haptic('selection');
            };

            const switchTab = (tab) => {
                currentTab.value = tab;
                haptic('selection');
            };

            const resetForm = () => {
                form.sizeCode = null;
                form.repairCode = null;
                form.riskCode = null;
                form.materialCode = null;
                form.carClassCode = null;
                form.disassemblyCode = null;
                form.hours = null;
                form.masterIndex = null;
                userSettings.hourlyRate = 0;
                haptic('selection');
            };

            const saveSettings = () => {
                const dataToSave = {
                    prices: userSettings.prices,
                    masters: userSettings.masters
                };
                localStorage.setItem('dentRepairSettings_v5', JSON.stringify(dataToSave));
                
                const tg = window.Telegram?.WebApp;
                if (tg && tg.showPopup && tg.isVersionAtLeast && tg.isVersionAtLeast('6.2')) {
                    tg.showPopup({ title: '–ì–æ—Ç–æ–≤–æ', message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', buttons: [{type:'ok'}] });
                } else {
                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                }
                haptic('success');
            };

            const resetDefaults = () => {
                const runReset = () => {
                    const defaultPrices = buildDefaultPrices();
                    // We do NOT reset masters anymore based on user request.
                    // const defaultMasters = JSON.parse(JSON.stringify(initialData.defaultMasters));
                    
                    // Update prices in place
                    Object.keys(userSettings.prices).forEach(key => delete userSettings.prices[key]);
                    Object.assign(userSettings.prices, defaultPrices);
                    
                    // userSettings.masters.splice(0, userSettings.masters.length, ...defaultMasters);
                    
                    // Save silently
                    const dataToSave = {
                        prices: userSettings.prices,
                        masters: userSettings.masters
                    };
                    localStorage.setItem('dentRepairSettings_v5', JSON.stringify(dataToSave));
                    
                    // Notify
                    const tg = window.Telegram?.WebApp;
                    if (tg && tg.showPopup && tg.isVersionAtLeast && tg.isVersionAtLeast('6.2')) {
                        tg.showPopup({ title: '–°–±—Ä–æ—Å', message: '–¶–µ–Ω—ã —Å–±—Ä–æ—à–µ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º', buttons: [{type:'ok'}] });
                    } else {
                        alert('–¶–µ–Ω—ã —Å–±—Ä–æ—à–µ–Ω—ã');
                    }
                    haptic('success');
                };

                const tg = window.Telegram?.WebApp;
                if (tg && tg.showConfirm && tg.isVersionAtLeast && tg.isVersionAtLeast('6.2')) {
                    tg.showConfirm("–°–±—Ä–æ—Å–∏—Ç—å —Ü–µ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º?", (ok) => { 
                        if (ok) runReset(); 
                    });
                } else {
                    if (confirm("–°–±—Ä–æ—Å–∏—Ç—å —Ü–µ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º?")) runReset();
                }
            };

            const formatCurrency = (val) => {
                return new Intl.NumberFormat('ru-RU').format(val);
            };

            const haptic = (type) => {
                const tg = window.Telegram?.WebApp;
                if (!tg?.HapticFeedback) return;
                if (tg.isVersionAtLeast && tg.isVersionAtLeast('6.1')) {
                    if (type === 'selection') tg.HapticFeedback.selectionChanged();
                    if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
                }
            };

            // Lifecycle
            onMounted(() => {
                // Load Settings (Prices & Masters)
                const savedData = localStorage.getItem('dentRepairSettings_v5');
                // Backward compatibility check for v4 price-only save
                const oldPrices = localStorage.getItem('dentRepairPrices_v4');

                if (savedData) {
                    try { 
                        const parsed = JSON.parse(savedData);
                        if(parsed.prices) Object.assign(userSettings.prices, parsed.prices);
                        if(parsed.masters) {
                             userSettings.masters.splice(0, userSettings.masters.length, ...parsed.masters);
                        }
                    } catch(e) { console.error(e); }
                } else if (oldPrices) {
                     try { 
                        Object.assign(userSettings.prices, JSON.parse(oldPrices)); 
                    } catch(e) { console.error(e); }
                }

                // Telegram Init
                if (window.Telegram?.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();
                    tg.setHeaderColor('#000000');
                    tg.setBackgroundColor('#000000');
                    
                    if (tg.MainButton.setParams) {
                        tg.MainButton.setParams({
                            color: '#88E523',
                            text_color: '#000000'
                        });
                    }
                    
                    tg.MainButton.onClick(() => {
                        if (currentTab.value !== 'calc') {
                            switchTab('calc');
                        } else {
                            haptic('success');
                        }
                    });
                }
            });

            // Update Telegram Main Button
            watch(totalPrice, (val) => {
                if (window.Telegram?.WebApp?.MainButton) {
                    const btn = window.Telegram.WebApp.MainButton;
                    if (val > 0) {
                        btn.setText(`–ò–¢–û–ì–û: ${formatCurrency(val)} ‚ÇΩ`);
                        btn.show();
                    } else {
                        btn.hide();
                    }
                }
            }, { immediate: true });

            return {
                currentTab, calcMode, form, userSettings, tabs,
                DATA: initialData, currentSizeList, totalPrice,
                setMode, setShape, switchTab, saveSettings, resetDefaults, 
                formatCurrency, updateRateFromMaster, resetForm,
                addMaster, removeMaster
            };
        }
    });

    APP.mount('#app');
</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>